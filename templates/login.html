{% extends "main.html" %}
{% block content %}
{% include "header.html" %}
{% include "flashmessages.html" %}
<!-- BEGIN Pre-requisites for Google platform library-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js">
</script>
<script src="https://apis.google.com/js/client:platform.js?onload=start" async defer>
</script>
<!-- END Pre-requisites for Google platform library-->

<!-- BEGIN Initialize the GoogleAuth object -->
<script>
  function start() {
    gapi.load('auth2', function() {
      auth2 = gapi.auth2.init({
        client_id: '490110762235-e2m329a4fn8e8to5tkuhiplm5vrrtdgj.apps.googleusercontent.com',
        // Scopes to request in addition to 'profile' and 'email'
        //scope: 'additional_scope'
      });
    });
  }
</script>
<!-- END Initialize the GoogleAuth object -->

<div id="signinButton">
    <span class="g-signin"
        data-scope="openid email"
        data-clientid="490110762235-e2m329a4fn8e8to5tkuhiplm5vrrtdgj.apps.googleusercontent.com"
        data-redirecturi="postmessage"
        data-accesstype="offline"
        data-cookiepolicy="single_host_origin"
        data-callback="signInCallback"
        data-approvalprompt="force">
    </span>
</div>

<div id="result"></div>


<!-- BEGIN define callback function from signinButton -->
<script>
function signInCallback(authResult) {
    if (authResult['code']) {

        // Hide the sign-in button now that the user is authorized
        $('#signinButton').attr('style', 'display:none');

        /******************
        Send the one-time-use code to the server, if the server responds, 
        write a 'login successful' message to the web page and then redirect 
        back to the main field guide page
        *******************/
        $.ajax(
        {
            type: 'POST',
            url: '/gconnect?state={{STATE}}',
            processData: false,
            data: authResult['code'],
            contentType: 'application/octet-stream; charset=utf-8',
            success: function(result) {
                // Handle or verify the server response if necessary.
                if (result) {
                    $('#result').html(
                        'Login Successful!</br>'+ result + '</br>Redirecting...'
                    )
                    // after 4 seconds, redirect to home page
                    setTimeout(function() {
                    window.location.href = "/";
                    }, 4000);
                } else if (authResult['error']) {
                    console.log('There was an error: ' + authResult['error']);
                } else {
                    $('#result').html(
                        'Failed to make a server-side call. Check your configuration and console.'
                    );
                }
            }
        }); 
    } 
}
</script>
<!-- End define callback function from signinButton -->

{% endblock content %}